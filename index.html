<!DOCTYPE html>
<html>
	<head>
		<title>„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ„Äú„Äú„Äú</title>

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Montserrat:wght@400&display=swap" rel="stylesheet">

		<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
		<link rel="icon" type="image/x-icon" href="favicon.ico">
		<link rel="manifest" href="site.webmanifest">

		<style>
			* {
				box-sizing: border-box;

				font-family: "Kosugi Maru", sans-serif;
				font-weight: 400;
				font-style: normal;
			}

			html, body {
				margin: 0;
				padding: 0;
			}

			body {
				height: 100vh;
				width: 100vw;
			}

			#oyasumi {
				height: 100%;
				width: 100%;

				background-color: #0e0e0e;

				display: flex;
				flex-direction: column;
				flex-wrap: nowrap;
				justify-content: center;
				align-items: center;
			}

			#msg {
				color: #f0f0f0;
				font-size: 3em;
				text-align: center;
			}

			#nav {
				display: flex;
				flex-direction: row;
				flex-wrap: nowrap;
				justify-content: center;
				align-items: center;
				column-gap: 4rem;
			}

			#reset {
				font-size: 5em;
				height: 2em;
				width: 2em;
			}

			#copy {
				transition: background-color 0.5s ease;
			}

			#copy.clicked {
				background-color: green;
			}

			button {
				display: flex;
				align-items: center;
				justify-content: center;

				background-color: #555;
				border-radius: 0.75rem;
				border: 0;
				color: #f0f0f0;
				font-family: 'Montserrat', sans-serif;
				font-size: 4em;
				padding: 2.5rem 3rem;
/*				line-height: 2.5rem;*/
				user-select: none;
				transition: transform 0.1s ease;
			}

			button:hover {
				background-color: #666;
				cursor: pointer;
			}

			button:active {
				transform: scale(1.05);
			}
		</style>

		<script type="text/javascript">
			window.addEventListener("load", main);

			/* 
			 * modified from http://www.voidware.com/moon_phase.htm
			 * https://gist.github.com/endel/dfe6bb2fbe679781948c
			 */
			function getMoonPhase(year, month, day) {
				var c = e = jd = b = 0;

				if (month < 3) {
					year--;
					month += 12;
				}

				++month;

				c = 365.25 * year;

				e = 30.6 * month;

				jd = c + e + day - 694039.09; //jd is total days elapsed

				jd /= 29.5305882; //divide by the moon cycle

				b = parseInt(jd); //int(jd) -> b, take integer part of jd

				jd -= b; //subtract integer part to leave fractional part of original jd

				b = Math.round(jd * 8); //scale fraction from 0-8 and round

				if (b >= 8 ) {
					b = 0; //0 and 8 are the same so turn 8 into 0
				}

				// 0 => New Moon
				// 1 => Waxing Crescent Moon
				// 2 => Quarter Moon
				// 3 => Waxing Gibbous Moon
				// 4 => Full Moon
				// 5 => Waning Gibbous Moon
				// 6 => Last Quarter Moon
				// 7 => Waning Crescent Moon

				return b;
			}

			function randomInt(min, max) {
				const r = Math.random();
				return Math.floor((1 - r) * min + r * (max + 1));
			}

			function generateGoodNightMessage() {
				const composition = [
					() => "„Åä„ÇÑ„Åô„Åø", // head

					() => {
						return Math.random() < 0.5 ? "„Å™„Åï„ÅÑ" : "";
					}, // suffix

					() => {
						return "„Äú".repeat(randomInt(1, 5));
					}, // emotion

					() => {
						return "‚ú®üöÄüë©‚ÄçüöÄ";
					}, // main emoji

					() => {
						const time = new Date();
						const year = time.getFullYear();
						const month = time.getMonth() + 1;
						const day = time.getDate();

						const PHASE = getMoonPhase(year, month, day);
						if (PHASE === 4)
							return "‚ú®üåï‚ú®";

						else if (Math.random() < 0.25)
							return ["üåë", "üåí", "üåì", "üåî", "üåï", "üåñ", "üåó", "üåò"][PHASE];

						return "";
					}, // moon phase emoji

					() => {
						return Math.random() < 0.05 ? "‚òÑÔ∏è" : "";
					}, // special head emoji

					() => {
						const genTrail = (em, min, max, rand = false) => {
							let g = "";
							em.forEach(emoji => g += emoji.repeat(rand === false ? randomInt(min, max) : rand));
							return g;
						}

						let trail = "";
						trail += genTrail(["ü•∞", "üòò", "‚ù§Ô∏è"], 4, 6);
						trail += "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";

						let r = Math.random() < 0.7 ? randomInt(3, 5) : 0;
						trail += genTrail(["üêªü§ó"], 0, 5, r);
						if (r > 0 && Math.random() < 0.8) {
							trail += "ü¶¥";
							trail += genTrail(["üí•"], 3, 5);
						}

						trail += genTrail(["üêØ"], 0, 4);

						return trail;
					}, // trailing emojis

					() => {
						return "‚ù§Ô∏èüê•";
					} // closing emojis
				];

				return composition.reduce((msg, gen) => msg += gen(), "");
			}

			function setGoodNightMessage(str, p) {
				p.innerHTML = str;
			}

			function main() {
				const msg = document.getElementById("msg");

				setGoodNightMessage(generateGoodNightMessage(), msg);
				
				document.getElementById("reset").addEventListener("click", () => 
					setGoodNightMessage(generateGoodNightMessage(), msg)
				);

				const copy = document.getElementById("copy");
				copy.addEventListener("click", () => {
					const msgStr = msg.textContent || msg.innerText;

					const api = document.createElement("textarea");
					api.value = msgStr;
					document.body.appendChild(api);
					api.select();
					document.execCommand("copy");
					document.body.removeChild(api);

					copy.innerHTML = "Copied ‚úì";
					copy.classList.add("clicked");

					setTimeout(() => {
						copy.innerHTML = "Copy";
						copy.classList.remove("clicked");
					}, 3000);
				});
			}
		</script>
	</head>

	<body>
		<div id="oyasumi">
			<p id="msg"></p>

			<div id="nav">
				<button type="button" id="reset">‚ü≥</button>
				<button type="button" id="copy">Copy</button>
			</div>
		</div>
	</body>
</html>
