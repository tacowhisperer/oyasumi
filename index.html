<!DOCTYPE html>
<html>
	<head>
		<!-- This will be my most cringe project lmao -->
		<title>„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ„Äú„Äú„Äú</title>

		<!-- Making it pretty on mobile too, like my tiguesita <3 -->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

		<!-- Cute Japanese font and button font -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Montserrat:wght@400&display=swap" rel="stylesheet">

		<!-- Corny icons for a corny page :P -->
		<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
		<link rel="icon" type="image/x-icon" href="favicon.ico">
		<link rel="manifest" href="site.webmanifest">

		<!-- Slick styles for sexy message delivery -->
		<style>
			/* Standard issue CSS to ensure that borders, padding, and margin behaves as it should have been defined in the first place. */
			* {
				box-sizing: border-box;
			}

			/* Standard issue CSS to ensure that all margin and padding definitions in the main body behave as expected. */
			html, body {
				margin: 0;
				padding: 0;
			}

			/* Why this is not already defined like this is beyond me. */
			body {
				height: 100vh;
				width: 100vw;
			}

			/* Main container for all output messages and buttons and whatever else is added later. */
			#oyasumi {
				height: 100%;
				width: 100%;

				background-color: #0e0e0e;

				/* Each successive item is centered in a column in a top-down fashion. */
				display: flex;
				flex-direction: column;
				flex-wrap: nowrap;
				justify-content: center;
				align-items: center;
				row-gap: 5vw;
			}

			/* Main container for the good night message. */
			#msg {
				font-family: "Kosugi Maru", sans-serif;
				font-weight: 400;
				font-style: normal;
				color: #f0f0f0;
				font-size: max(3vw, 3vh);
				text-align: center;

				/* Things get cluttered on a small display */
				max-width: 80%;

				/* Cute little animation to pop in in conjunction with the .show class */
				opacity: 0;
				transform: translateY(0.75em);
				transition: opacity 0.2s ease, transform 0.2s ease;
			}

			/* The big reveal of the good night message. */
			#msg.show {
				opacity: 1;
				transform: translateY(0);
			}

			/* Main container for buttons */
			#nav {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				justify-content: center;
				align-items: center;
				column-gap: 5vw;
			}

			/* The reset button went through much pain to finally arrive at this */
			#reset {
				background-image: url("reload.svg");
				background-size: 5vw;
				background-position: center center;
				background-repeat: no-repeat;

				height: 10vw;
				width: 10vw;
			}

			/* Making the visual cue less jarring to see pop into view */
			#copy {
				transition: background-color 0.5s ease;
			}

			/* A big visual cue that the copy button worked */
			#copy.clicked {
				background-color: green;
			}

			/* Since the "Copy" text has fewer chars than "Copied ‚úì", it's removed from the containing button so that
			it doesn't resize when the copied message is faded in and this one fades out */
			#copymsg {
				position: absolute;
				opacity: 1;
				transition: opacity 0.1s ease;
			}

			#copymsg.clicked {
				opacity: 0;
			}

			#copiedmsg {
				opacity: 0;
				transition: opacity 0.1s ease;
			}

			#copiedmsg.clicked {
				opacity: 1;
			}

			/* Some button styling */
			.button {
				display: flex;
				align-items: center;
				justify-content: center;

				background-color: #555;
				border-radius: 0.75vw;
				border: 0;
				color: #f0f0f0;
				font-family: 'Montserrat', sans-serif;
				font-size: 4vw;
				padding: 2.5vw 3vw;
				user-select: none;
				transition: transform 0.05s ease;

				/* On Chrome mobile, tapping the button gives it a blue highlight that gets in the way of my CSS */
				-webkit-tap-highlight-color: transparent;
			}

			.button:hover {
				cursor: pointer;
			}

			.button:active {
				transform: scale(1.15);
			}
		</style>

		<!-- And a dash of JS magic to tie it all together~~~ -->
		<script type="text/javascript">
			// Only execute code once the page has fully loaded. Helps avoid putting script in the footer
			window.addEventListener("load", main);

			/**
			 * Generates a random integer from min to max, inclusive.
			 */
			function randInt(min, max) {
				return Math.floor(Math.random() * (max - min + 1) + min);
			}

			/**
			 * Modified from http://www.voidware.com/moon_phase.htm
			 * source: https://gist.github.com/endel/dfe6bb2fbe679781948c
			 * 
			 * Calculates the current Moon phase and returns a number to indicate the position.
			 * 
			 * 0 => New Moon
			 * 1 => Waxing Crescent Moon
			 * 2 => Quarter Moon
			 * 3 => Waxing Gibbous Moon
			 * 4 => Full Moon
			 * 5 => Waning Gibbous Moon
			 * 6 => Last Quarter Moon
			 * 7 => Waning Crescent Moon
			 */
			function getMoonPhase(year, month, day) {
				let c = e = jd = b = 0;

				if (month < 3) {
					year--;
					month += 12;
				}

				month++;

				c = 365.25 * year;
				e = 30.6 * month;

				jd = c + e + day - 694039.09; //jd is total days elapsed
				jd /= 29.5305882; //divide by the moon cycle

				b = parseInt(jd); //int(jd) -> b, take integer part of jd
				jd -= b; //subtract integer part to leave fractional part of original jd
				b = Math.round(jd * 8); //scale fraction from 0-8 and round

				return b % 8;
			}

			/**
			 * Generates the good night message string that is output to the view.
			 * 
			 * unlockables - An Array of emojis that are available for use beside the ones defined in this function.
			 */
			function generateGoodNightMessage(unlockables = []) {
				const u = Math.random;

				// The message is generated in parts, and each part is called and concatenated in sequence.
				const composition = [
					() => "„Åä„ÇÑ„Åô„Åø", // head

					() => u() < 0.5 ? "„Å™„Åï„ÅÑ" : "", // suffix

					() => "„Äú".repeat(randInt(1, 5)), // emotion

					() => "‚ú®üöÄüë©‚ÄçüöÄ", // head emoji

					() => {
						// Get the current year, month, and day
						const time = new Date();
						const year = time.getFullYear();
						const month = time.getMonth() + 1;
						const day = time.getDate();

						const PHASE = getMoonPhase(year, month, day);
						if (PHASE === 4)
							return "‚ú®üåï‚ú®"; // Always show the full moon <3

						// Only show the current phase about a quarter of the time..
						return u() < 0.25 ? ["üåë", "üåí", "üåì", "üåî", "üåï", "üåñ", "üåó", "üåò"][PHASE] : "";
					}, // moon phase emoji

					() => u() < 0.05 ? "‚òÑÔ∏è" : "", // special head emoji

					() => {
						/**
						 * Helper function for generating trailing emoji.
						 * em - Array of emojis that need to be trailed
						 * min - The minimum length of the trail
						 * max - The maximum length of the trail
						 * n - A Number if the trail must be exactly n emojis long, or not a number otherwise
						 * s - An array of emojis that can be sprinkled into the trail. The trail length grows in this
						 *     case.
						 * p - The probability that a sprinkle emoji will be added.
						 */
						const genTrail = (em, min, max, n = null, s = [""], p = 0.15) => {
							if (n === 0)
								return "";

							let t = "";
							em.forEach(emoji => {
								const c = typeof n === "number" ? n : randInt(min, max);
								for (let i = 0; i < c; i++) {
									// An emoji is sprinkled in from Array s with p probability
									t += emoji + (u() < p ? s[Math.floor(u() * s.length)] : "");
								}
							});
							return t;
						}

						// Final trail output
						let trail = "";

						// First wave. Can't get enough love honestly.
						trail += genTrail(["ü•∞", "üòò"], 4, 6, null, ["‚ù§Ô∏è", "üòç", "üíã", "üòã"]);
						trail += genTrail(["‚ù§Ô∏è"], 6, 9);

						// Don't always include the bear hugs, but when I do, they're tight
						let n = u() < 0.7 ? randInt(3, 5) : 0;
						trail += genTrail(["üêªü§ó"], 3, 5, n, ["üêØ"]); // with some tiger bites
						if (n > 0 && u() < 0.8) {
							// Sometimes the hugs crush your bones
							trail += "ü¶¥";
							trail += genTrail(["üí•"], 3, 5);

							// And even rarer... blow your mind!
							trail += u() < 0.1 ? "ü§Øüòµü§™" : "";
						}

						// Can't forget the trailing tiger bites!
						trail += genTrail(["üêØ"], 0, 4);

						return trail;
					}, // trailing emojis

					() => "‚ù§Ô∏èüê•" // closing emojis
				];

				// Concatenate the final result
				return composition.reduce((msg, gen) => msg += gen(), "");
			}

			/**
			 * Takes a generated good night message and sticks it into the provided DOM element. The first time this
			 * function is called should be without a delay.
			 * 
			 * str - The good night message string
			 * e - The DOM element to attach the message to.
			 * init - Whether or not this is the first time the function is called.
			 */
			function setGoodNightMessage(str, e, init = false) {
				if (init) {
					e.innerHTML = str;
					e.classList.add("show");
					return;
				}

				e.classList.remove("show");
				setTimeout(() => {
					e.innerHTML = str;
					e.classList.add("show");
				}, 250);
			}

			/**
			 * Executes once the DOM has successfully loaded.
			 */
			function main() {
				// Determine if touch is available, and if so, use that instead of click events
				const activator = window.ontouchstart ? "touchstart" : "click";

				// DOM element that holds the good night message
				const msg = document.getElementById("msg");

				// Set the initial good night message that will display on page load
				setGoodNightMessage(generateGoodNightMessage(), msg, true);
				
				// Makes the reset button generate a new good night message if the one on screen isn't up to par
				document.getElementById("reset").addEventListener(activator, () => 
					setGoodNightMessage(generateGoodNightMessage(), msg)
				);

				// Set up the copy button and the message functionality to provide feedback on success
				const copy = document.getElementById("copy");
				const copymsg = document.getElementById("copymsg");
				const copiedmsg = document.getElementById("copiedmsg");
				copy.addEventListener(activator, () => {
					// Get the good night message
					const msgStr = msg.textContent || msg.innerText;

					// Use the available API to copy the message to the device clipboard
					const api = document.createElement("textarea");
					api.value = msgStr;
					document.body.appendChild(api);
					api.select();
					document.execCommand("copy");
					document.body.removeChild(api);

					// Allow predefined CSS to handle animations and such
					[copy, copymsg, copiedmsg].forEach(e => e.classList.add("clicked"));

					// Return to the original state after a few seconds to reset in case of another copy on the same page load
					setTimeout(() => {
						[copy, copymsg, copiedmsg].forEach(e => e.classList.remove("clicked"));
					}, 3000);
				});
			}
		</script>
	</head>

	<body>
		<!-- Main container for all of the content -->
		<div id="oyasumi">
			<!-- Good night message container -->
			<div id="msg"></div>

			<!-- Button container -->
			<div id="nav">
				<!-- Resets the good night message -->
				<div class="button" type="button" id="reset"></div>

				<!-- Copies the good night message to the clipboard -->
				<div class="button" type="button" id="copy"><span id="copymsg">Copy</span><span id="copiedmsg">Copied ‚úì</span></div>

				<!-- Toggle for special emojis -->
				<!-- <div class="button"></div> -->
			</div>
		</div>

		<footer>
			<!-- Con mucho amor, tiguesito <3 -->
		</footer>
	</body>
</html>
